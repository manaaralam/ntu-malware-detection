# -*- coding: utf-8 -*-
"""
Created on Thu Aug 31 2017

@author: N1705165D (Manaar)
"""

import os
import parameters as param
import pandas as pd
import numpy as np
import random
import timeit

from sklearn.neural_network import MLPClassifier
from sklearn.linear_model import LogisticRegression
from sklearn.naive_bayes import GaussianNB
from sklearn.svm import LinearSVC
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import f1_score
import matplotlib.pyplot as plt

def create_benign_and_malware_files():
    if not os.path.exists(param.data_file):
#        print("Data File Not Found..!!")
        return
    if not (os.path.exists(param.benign_directory) and os.path.exists(param.malware_directory)):
        os.makedirs(param.benign_directory)
        os.makedirs(param.malware_directory)
    raw_data = pd.read_csv(param.data_file, dtype='float64', header=None).as_matrix()[:, :-1]
    for i in range(param.total_benign):
        np.savetxt(param.benign_directory+"prog"+str(i+1)+".txt", raw_data[(i*50):((i+1)*50), :], fmt="%.1f")
    for i in range(param.total_malware):
        np.savetxt(param.malware_directory+"prog"+str(i+1)+".txt", raw_data[((54*50)+(i*50)):((54*50)+(i+1)*50), :], fmt="%.1f")
#    print("All the Benign and Malware files created..")

def generate_benign_data(i):
    if not os.path.exists(param.temporary_directory):
        os.makedirs(param.temporary_directory)
    train_benign = random.sample(range(1, param.total_benign + 1), param.total_benign - param.num_test_benign)
    test_benign = []
    for item in range(1, param.total_benign + 1):
        if item not in train_benign:
            test_benign.append(item)
    train_benign.sort()
    test_benign.sort()
    with open(param.temporary_directory+"train_benign_program_list"+str(i)+".txt", "w") as outFile:
        for item in train_benign:
            outFile.write("%s " % item)
    with open(param.temporary_directory+"test_benign_program_list"+str(i)+".txt", "w") as outFile:
        for item in test_benign:
            outFile.write("%s " % item)
#    print("Benign Train and Test files are selected..")
    return train_benign, test_benign

def generate_malware_data(i):
    train_malware = random.sample(range(1, param.total_malware + 1), param.total_malware - param.num_test_malware)
    test_malware = []
    for item in range(1, param.total_malware + 1):
        if item not in train_malware:
            test_malware.append(item)
    train_malware.sort()
    test_malware.sort()
    with open(param.temporary_directory+"train_malware_program_list"+str(i)+".txt", "w") as outFile:
        for item in train_malware:
            outFile.write("%s " % item)
    with open(param.temporary_directory+"test_malware_program_list"+str(i)+".txt", "w") as outFile:
        for item in test_malware:
            outFile.write("%s " % item)
#    print("Malware Train and Test files are selected..")
    return train_malware, test_malware

def createDataSet(i):
    with open("data/train_data"+str(i)+".txt", "w") as outFile:
        with open("tempData/train_benign_program_list"+str(i)+".txt", "r") as inFile:
            content = inFile.readlines()
        content = content[0].strip().split(" ")
        for item in content:
            with open("benign/prog"+item+".txt") as dataFile:
                data = dataFile.readlines()
            for lines in data:
                outFile.write(lines.strip() + " 0\n")
        with open("tempData/train_malware_program_list"+str(i)+".txt", "r") as inFile:
            content = inFile.readlines()
        content = content[0].strip().split(" ")
        for item in content:
            with open("malware/prog"+item+".txt") as dataFile:
                data = dataFile.readlines()
            for lines in data:
                outFile.write(lines.strip() + " 1\n")
    with open("data/test_data"+str(i)+".txt", "w") as outFile:
        with open("tempData/test_benign_program_list"+str(i)+".txt", "r") as inFile:
            content = inFile.readlines()
        content = content[0].strip().split(" ")
        for item in content:
            with open("benign/prog"+item+".txt") as dataFile:
                data = dataFile.readlines()
            for lines in data:
                outFile.write(lines.strip() + " 0\n")
        with open("tempData/test_malware_program_list"+str(i)+".txt", "r") as inFile:
            content = inFile.readlines()
        content = content[0].strip().split(" ")
        for item in content:
            with open("malware/prog"+item+".txt") as dataFile:
                data = dataFile.readlines()
            for lines in data:
                outFile.write(lines.strip() + " 1\n")

def get_score(pred):
    file_y_test = []
    for _ in range(10):
        file_y_test.append(0)
    for _ in range(10):
        file_y_test.append(1)
    pred_y_test = []
    for i in range(10):
        c = sum(x==0 for x in pred[50*i:50*(i+1)])
        if c == 50:
            pred_y_test.append(0)
        else:
            pred_y_test.append(1)
    for i in range(10):
        c = sum(x==1 for x in pred[500+50*i:500+50*(i+1)])
        if c == 50:
            pred_y_test.append(1)
        else:
            pred_y_test.append(0)
    return f1_score(file_y_test, pred_y_test)

def get_score_mod(pred):
    file_y_test = []
    for _ in range(10):
        file_y_test.append(0)
    for _ in range(10):
        file_y_test.append(1)
    pred_y_test = []
    for i in range(10):
        c = sum(x==0 for x in pred[50*i:50*(i+1)])
        if c > 48:
            pred_y_test.append(0)
        else:
            pred_y_test.append(1)
    for i in range(10):
        c = sum(x==1 for x in pred[500+50*i:500+50*(i+1)])
        if c > 48:
            pred_y_test.append(1)
        else:
            pred_y_test.append(0)
    return f1_score(file_y_test, pred_y_test)

def train_model(clf):
    train_time = [[] for i in range(5)]
    prediction_time = [[] for i in range(5)]
    score = [[] for i in range(5)]
    for i in range(1000):
        print(i)
        train_benign, test_benign = generate_benign_data(i)
        train_malware, test_malware = generate_malware_data(i)
        createDataSet(i)
        train_data = pd.read_csv("data/train_data"+str(i)+".txt", header=None, sep=" ").as_matrix()
        test_data = pd.read_csv("data/test_data"+str(i)+".txt", header=None, sep=" ").as_matrix()
        X_train = train_data[:, :-1]
        y_train = train_data[:, -1]
        X_test = test_data[:, :-1]
        for i in range(5):
            start = timeit.default_timer()
            model = clf[i].fit(X_train, y_train)
            end = timeit.default_timer()
            time_to_train = (end - start)*1e3
            train_time[i].append(time_to_train)
                
            start = timeit.default_timer()
            pred = model.predict(X_test)
            end = timeit.default_timer()
            time_to_predict = (end - start)*1e6
            prediction_time[i].append(time_to_predict)
            
            pred = model.predict(X_test)
            if i==0 or i==3:
                score[i].append(get_score_mod(pred))
            else:
                score[i].append(get_score(pred))
    return score, train_time, prediction_time

def draw_plot(ax, data, edge_color, fill_color):
    bp = ax.boxplot(data, patch_artist=True, sym="")
    for element in ['boxes', 'whiskers', 'medians']:
        plt.setp(bp[element], color=edge_color)
    for patch in bp['boxes']:
        patch.set(facecolor=fill_color)

def main():
    create_benign_and_malware_files()
    clf = []
    clf.append(MLPClassifier())
    clf.append(LogisticRegression())
    clf.append(GaussianNB())
    clf.append(LinearSVC())
    clf.append(RandomForestClassifier())
    score, train_time, test_time = train_model(clf)
    fig, ax = plt.subplots()
    draw_plot(ax, [score[0], score[1], score[2], score[3], score[4]], 'blue', 'cyan')
    plt.xticks([1, 2, 3, 4, 5], ["Multilayer Perceptron", "Logistic Regression", "Gaussian Naive Bayes", "Support Vector Machine", "Random Forest"], rotation='vertical')
    plt.ylabel("F1-Score")
    plt.show()
    for i in range(len(score)):
        print(np.mean(score[i]), np.mean(train_time[i]), np.mean(test_time[i]))
        np.savetxt("score_"+str(i)+".txt", score[i], fmt="%0.10f")
        np.savetxt("train_time_"+str(i)+".txt", train_time[i], fmt="%0.10f")
        np.savetxt("test_time_"+str(i)+".txt", test_time[i], fmt="%0.10f")
#    plt.savefig("f_scores.png", dpi=1000, bbox_inches='tight')

if __name__ == "__main__":
    main()