# -*- coding: utf-8 -*-
"""
Created on Wed Sep  6 15:56:40 2017

@author: N1705165D
"""

import pandas as pd
import numpy as np
import parameters as param
import os
import random
import math

Matrix = [[0 for x in range(param.num_hpc)] for y in range(param.num_indicator)]
Bin = [[[[0 for x in range(param.num_hpc)] for y in range(param.num_indicator)] for f1 in range(param.total_malware)] for f2 in range(param.total_benign)]
Weights = [[0 for x in range(param.num_hpc)] for y in range(param.num_indicator)]
BinTest = [[[[0 for x in range(param.num_hpc)] for y in range(param.num_indicator)] for f1 in range(param.total_malware)] for f2 in range(param.total_benign)]

def create_benign_and_malware_files():
    if not os.path.exists(param.data_file):
        print("Data File Not Found..!!")
        return
    if not (os.path.exists(param.benign_directory) and os.path.exists(param.malware_directory)):
        os.makedirs(param.benign_directory)
        os.makedirs(param.malware_directory)
    raw_data = pd.read_csv(param.data_file, dtype='float64', header=None).as_matrix()[:, :-1]
    for i in range(param.total_benign):
        np.savetxt(param.benign_directory+"prog"+str(i+1)+".txt", raw_data[(i*50):((i+1)*50), :], fmt="%.1f")
    for i in range(param.num_backdoor):
        np.savetxt(param.malware_directory+"backdoor"+str(i+1)+".txt", raw_data[((54*50)+(i*50)):((54*50)+(i+1)*50), :], fmt="%.1f")
    for i in range(param.num_exploit):
        np.savetxt(param.malware_directory+"exploit"+str(i+1)+".txt", raw_data[((92*50)+(i*50)):((92*50)+(i+1)*50), :], fmt="%.1f")
    for i in range(param.num_flooder):
        np.savetxt(param.malware_directory+"flooder"+str(i+1)+".txt", raw_data[((114*50)+(i*50)):((114*50)+(i+1)*50), :], fmt="%.1f")
    for i in range(param.num_trojan):
        np.savetxt(param.malware_directory+"trojan"+str(i+1)+".txt", raw_data[((124*50)+(i*50)):((124*50)+(i+1)*50), :], fmt="%.1f")
    for i in range(param.num_virus):
        np.savetxt(param.malware_directory+"virus"+str(i+1)+".txt", raw_data[((137*50)+(i*50)):((137*50)+(i+1)*50), :], fmt="%.1f")
    print("All the Benign and Malware files created..")

def generate_benign_data():
    if not os.path.exists(param.temporary_directory):
        os.makedirs(param.temporary_directory)
    train_benign = random.sample(range(1, param.total_benign + 1), param.total_benign - param.num_test_benign)
    test_benign = []
    for item in range(1, param.total_benign + 1):
        if item not in train_benign:
            test_benign.append(item)
    train_benign.sort()
    test_benign.sort()
    with open(param.temporary_directory+"train_benign_program_list.txt", "w") as outFile:
        for item in train_benign:
            outFile.write("%s " % item)
    with open(param.temporary_directory+"test_benign_program_list.txt", "w") as outFile:
        for item in test_benign:
            outFile.write("%s " % item)
    print("Benign Train and Test files are selected..")

def generate_malware_data():
    if os.path.exists(param.temporary_directory+"train_malware_program_list.txt"):
        os.remove(param.temporary_directory+"train_malware_program_list.txt")
    if os.path.exists(param.temporary_directory+"test_malware_program_list.txt"):
        os.remove(param.temporary_directory+"test_malware_program_list.txt")
    types_of_malware = ["backdoor", "exploit", "flooder", "trojan", "virus"]
    for mal_type in types_of_malware:
        if mal_type == "backdoor":
            val_range = param.num_backdoor
            test_range = 3
        if mal_type == "exploit":
            val_range = param.num_exploit
            test_range = 3
        if mal_type == "flooder":
            val_range = param.num_flooder
            test_range = 1
        if mal_type == "trojan":
            val_range = param.num_trojan
            test_range = 1
        if mal_type == "virus":
            val_range = param.num_virus
            test_range = 2
        train_malware = random.sample(range(1, val_range + 1), val_range - test_range)
        test_malware = []
        for item in range(1, val_range + 1):
            if item not in train_malware:
                test_malware.append(item)
        train_malware.sort()
        test_malware.sort()
        with open(param.temporary_directory+"train_malware_program_list.txt", "a") as outFile:
            for item in train_malware:
                outFile.write("%s " % item)
            outFile.write("\n")
        with open(param.temporary_directory+"test_malware_program_list.txt", "a") as outFile:
            for item in test_malware:
                outFile.write("%s " % item)
            outFile.write("\n")
    print("Malware Train and Test files are selected..")

def create_t_values():
    types_of_malware = ["backdoor", "exploit", "flooder", "trojan", "virus"]
    print("Creating t-values for all the (benign, malware) tuple..")
    if not os.path.exists(param.t_values_directory):
        os.makedirs(param.t_values_directory)
    for file1 in range(1, param.total_benign + 1):
        for mal_type in types_of_malware:
            if mal_type == "backdoor":
                val_range = param.num_backdoor
            if mal_type == "exploit":
                val_range = param.num_exploit
            if mal_type == "flooder":
                val_range = param.num_flooder
            if mal_type == "trojan":
                val_range = param.num_trojan
            if mal_type == "virus":
                val_range = param.num_virus
            for file2 in range(1, val_range + 1):
                data1 = pd.read_csv(param.benign_directory+"prog"+str(file1)+".txt", header=None, sep=" ").as_matrix()
                data2 = pd.read_csv(param.malware_directory+mal_type+str(file2)+".txt", header=None, sep=" ").as_matrix()
                for c in range(param.num_hpc):
                    for r in range(param.num_indicator):
                        dis1 = data1[:, param.num_indicator * c + r]
                        dis2 = data2[:, param.num_indicator * c + r]
                        t = (np.mean(dis1) - np.mean(dis2)) / (math.sqrt((np.var(dis1) + np.var(dis2))/len(dis1)))
                        Matrix[r][c] = t
                np.savetxt(param.t_values_directory+"benign"+str(file1)+"_"+mal_type+str(file2)+".txt", Matrix, delimiter = " ", fmt="%0.6f")
    print("All t-values created..")

def calculate_Bin(file1, file2, mal_type):
    if mal_type == 0:
        malware = "backdoor"
    if mal_type == 1:
        malware = "exploit"
    if mal_type == 2:
        malware = "flooder"
    if mal_type == 3:
        malware = "trojan"
    if mal_type == 4:
        malware = "virus"
    data = pd.read_csv(param.t_values_directory+"benign"+str(file1)+"_"+malware+str(file2)+".txt", header=None, sep=" ").as_matrix()
    for r in range(param.num_indicator):
        for c in range(param.num_hpc):
            if abs(data[r][c]) >= param.t_critical:
                Bin[file1 - 1][file2 - 1][r][c] = 1

def store_bins():
    if not os.path.exists(param.bin_directory):
        os.makedirs(param.bin_directory)
    for b in range(param.total_benign):
        for m in range(param.total_malware):
            np.savetxt(param.bin_directory+"b"+str(b)+"_m"+str(m)+".txt", Bin[b][m], delimiter = " ", fmt="%0.0f")
            
def calculate_weights():
    print("Creating weights for train set data..")
    total_count = 0
    for r in range(param.num_indicator):
        for c in range(param.num_hpc):
            count = 0
            for b in range(param.total_benign):
                for m in range(param.total_malware):
                    if Bin[b][m][r][c] == 1:
                        count = count + 1
            Weights[r][c] = count
            total_count = total_count + count
    np.savetxt("weights.txt", Weights, delimiter = " ", fmt="%0.0f")
    for r in range(param.num_indicator):
        for c in range(param.num_hpc):
            Weights[r][c] = Weights[r][c] / total_count    
    np.savetxt("normalized_weights.txt", Weights, delimiter = " ", fmt="%0.6f")
    print("Weights are created..")

def train_t_test_model(benign, malware):
    print("Training Started..")
    print("Creating Bin Files for train set data..")
    for item in benign:
        for b in item:
            for mal_type in malware:
                for m in mal_type:
                    calculate_Bin(b, m, malware.index(mal_type))
    store_bins()
    print("Bin Files Created..")
    calculate_weights()
    print("Training Complete..")

def calculate_Bin_testing(file1, file2, index):
    data1 = pd.read_csv(param.benign_directory+"prog"+str(file1)+".txt", header=None, sep=" ").as_matrix()
    if index == 0:
        data2 = pd.read_csv(param.benign_directory+"prog"+str(file2)+".txt", header=None, sep=" ").as_matrix()
    if index == 1:
        data2 = pd.read_csv(param.malware_directory+"backdoor"+str(file2)+".txt", header=None, sep=" ").as_matrix()
    if index == 2:
        data2 = pd.read_csv(param.malware_directory+"exploit"+str(file2)+".txt", header=None, sep=" ").as_matrix()
    if index == 3:
        data2 = pd.read_csv(param.malware_directory+"flooder"+str(file2)+".txt", header=None, sep=" ").as_matrix()
    if index == 4:
        data2 = pd.read_csv(param.malware_directory+"trojan"+str(file2)+".txt", header=None, sep=" ").as_matrix()
    if index == 5:
        data2 = pd.read_csv(param.malware_directory+"virus"+str(file2)+".txt", header=None, sep=" ").as_matrix()
    for c in range(param.num_hpc):
        for r in range(param.num_indicator):
            dis1 = data1[:, param.num_indicator * c + r]
            dis2 = data2[:, param.num_indicator * c + r]
            t = (np.mean(dis1) - np.mean(dis2)) / (math.sqrt((np.var(dis1)+np.var(dis2))/len(dis1)))
            if abs(t) >= param.t_critical:
                BinTest[file1 - 1][file2 - 1][r][c] = 1

def analyze(t, fileCount):
    if not os.path.exists(param.test_directory):
        os.makedirs(param.test_directory)
    binning = [[0 for x in range(param.num_hpc)] for y in range(param.num_indicator)]
    for r in range(param.num_indicator):
        for c in range(param.num_hpc):
            count = 0
            for b in range(param.total_benign):
                    if BinTest[b][t-1][r][c] == 1:
                        count = count + 1
            binning[r][c] = count
    np.savetxt("Testing_Results/count_"+str(fileCount)+".txt", binning, delimiter = " ", fmt="%0.0f")
    for r in range(param.num_indicator):
        for c in range(param.num_hpc):
            binning[r][c] = binning[r][c] / (param.total_benign - param.num_test_benign)
    np.savetxt("Testing_Results/normalized_count_"+str(fileCount)+".txt", binning, delimiter = " ", fmt="%0.6f")
    weight = pd.read_csv("normalized_weights.txt", header = None, sep=" ").as_matrix()
    result = np.matrix(np.multiply(binning, weight))
    np.savetxt("Testing_Results/score_"+str(fileCount)+".txt", result, delimiter = " ", fmt="%0.6f")
    score = result.sum()
    return 0 if score < param.threshold else 1, score

def initialize():
    for a in range(param.total_benign):
        for b in range(param.total_malware):
            for i in range(param.num_indicator):
                for j in range(param.num_hpc):
                    BinTest[a][b][i][j] = 0
                    
def test_t_test_model(benign, target):
    test_file_index = 0
    print("Testing Started..")
    pred = []
    for test_item in target:
        for t in test_item:
            print("Testing File %d" % (test_file_index + 1))
            initialize()
            for train_item in benign:
                for b in train_item:
                    calculate_Bin_testing(b, t, target.index(test_item))
            pred.append(analyze(t, test_file_index + 1))
            test_file_index = test_file_index + 1
    print("Testing Complete..")
    return pred

def getDataSet():
    with open(param.temporary_directory+"train_benign_program_list.txt", "r") as inpFile:
        lines = inpFile.readlines()
        train_benign = []
        for item in lines:
            content = item.split()
        numbers = [int(x) for x in content]
        train_benign.append(numbers)
    with open(param.temporary_directory+"train_malware_program_list.txt", "r") as inpFile:
        lines = inpFile.readlines()
        train_malware = []
        content = []
        for item in lines:
            content.append(item.split())
        for item in content:
            train_malware.append([int(x) for x in item])
    with open(param.temporary_directory+"test_benign_program_list.txt", "r") as inpFile:
        lines = inpFile.readlines()
        test_benign = []
        for item in lines:
            content = item.split()
        numbers = [int(x) for x in content]
        test_benign.append(numbers)
    with open(param.temporary_directory+"test_malware_program_list.txt", "r") as inpFile:
        lines = inpFile.readlines()
        test_malware = []
        content = []
        for item in lines:
            content.append(item.split())
        for item in content:
            test_malware.append([int(x) for x in item])
    return train_benign, test_benign, train_malware, test_malware

def main():
#    create_benign_and_malware_files()
#    create_t_values()
    generate_benign_data()
    generate_malware_data()
    train_benign, test_benign, train_malware, test_malware = getDataSet()
    train_t_test_model(train_benign, train_malware)
    pred = test_t_test_model(train_benign, test_benign + test_malware)
    with open(str(param.alpha)+"_score.txt", "w") as out:
        for item in pred:
            print("%d -> %0.6f (%s)" % (item[0], item[1], "Benign" if item[0] == 0 else "Malware"))
            out.write("%s\n" % item[1])

if __name__ == "__main__":
    main()