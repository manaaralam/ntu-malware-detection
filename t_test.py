# -*- coding: utf-8 -*-
"""
Created on Sun Sep 3 2017

@author: N1705165D (Manaar)
"""

import pandas as pd
import timeit
import numpy as np
import math
import parameters as param
import os

Matrix = [[0 for x in range(param.num_hpc)] for y in range(param.num_indicator)]
Bin = [[[[0 for x in range(param.num_hpc)] for y in range(param.num_indicator)] for f1 in range(param.total_malware)] for f2 in range(param.total_benign)]
Weights = [[0 for x in range(param.num_hpc)] for y in range(param.num_indicator)]
BinTest = [[[[0 for x in range(param.num_hpc)] for y in range(param.num_indicator)] for f1 in range(param.total_malware)] for f2 in range(param.total_benign)]

prediction_time = 0

def calculate_weights():
    total_count = 0
    time = 0
    start = timeit.default_timer()
    for r in range(param.num_indicator):
        for c in range(param.num_hpc):
            count = 0
            for b in range(param.total_benign):
                for m in range(param.total_malware):
                    if Bin[b][m][r][c] == 1:
                        count = count + 1
            Weights[r][c] = count
            total_count = total_count + count
    end = timeit.default_timer()
    time = time + (end - start)
    np.savetxt("weights.txt", Weights, delimiter = " ", fmt="%0.0f")
    start = timeit.default_timer()
    for r in range(param.num_indicator):
        for c in range(param.num_hpc):
            Weights[r][c] = Weights[r][c] / total_count
    end = timeit.default_timer()
    time = time + (end - start)
    np.savetxt("normalized_weights.txt", Weights, delimiter = " ", fmt="%0.6f")
    return ((time/(param.total_benign*param.total_malware))*((param.total_benign-param.num_test_benign)*(param.total_malware-param.num_test_malware)))

def create_T_values():
    if not os.path.exists(param.t_values_directory):
        os.makedirs(param.t_values_directory)
    total_time = 0
    for file1 in range(1, param.total_benign + 1):
        for file2 in range(1, param.total_malware + 1):
            data1 = pd.read_csv(param.benign_directory+"prog"+str(file1)+".txt", header=None, sep=" ").as_matrix()
            data2 = pd.read_csv(param.malware_directory+"prog"+str(file2)+".txt", header=None, sep=" ").as_matrix()
            for c in range(param.num_hpc):
                for r in range(param.num_indicator):
                    dis1 = data1[:, c+r]
                    dis2 = data2[:, c+r]
                    start = timeit.default_timer()
                    t = (np.mean(dis1) - np.mean(dis2)) / (math.sqrt((np.var(dis1)+np.var(dis2))/len(dis1)))
                    end = timeit.default_timer()
                    total_time = total_time + (end - start)
                    Matrix[r][c] = t
            np.savetxt(param.t_values_directory+"b"+str(file1)+"_m"+str(file2)+".txt", Matrix, delimiter = " ", fmt="%0.6f")
    return ((total_time/(param.total_benign*param.total_malware))*((param.total_benign-param.num_test_benign)*(param.total_malware-param.num_test_malware)))

def calculate_Bin(file1, file2):
    data = pd.read_csv(param.t_values_directory+"b"+str(file1)+"_m"+str(file2)+".txt", header=None, sep=" ").as_matrix()
    total_time = 0
    for r in range(param.num_indicator):
        for c in range(param.num_hpc):
            start = timeit.default_timer()
            if abs(data[r][c]) >= param.t_critical:
                Bin[file1 - 1][file2 - 1][r][c] = 1
            end = timeit.default_timer()
            total_time = total_time + (end - start)
    return total_time

def calculate_Bin_testing(file1, file2, index):
    global prediction_time
    data1 = pd.read_csv(param.benign_directory+"prog"+str(file1)+".txt", header=None, sep=" ").as_matrix()
    if index < 10:
        data2 = pd.read_csv(param.benign_directory+"prog"+str(file2)+".txt", header=None, sep=" ").as_matrix()
    else:
        data2 = pd.read_csv(param.malware_directory+"prog"+str(file2)+".txt", header=None, sep=" ").as_matrix()
    for c in range(param.num_hpc):
        for r in range(param.num_indicator):
            dis1 = data1[:, c+r]
            dis2 = data2[:, c+r]
            start = timeit.default_timer()
            t = (np.mean(dis1) - np.mean(dis2)) / (math.sqrt((np.var(dis1)+np.var(dis2))/len(dis1)))
            if  abs(t) >= param.t_critical:
                BinTest[file1 - 1][file2 - 1][r][c] = 1
            end = timeit.default_timer()
            prediction_time = prediction_time + (end - start)

fileCount = 0
def analyze(t):
    if not os.path.exists(param.test_directory):
        os.makedirs(param.test_directory)
    global prediction_time
    global fileCount
    binning = [[0 for x in range(param.num_hpc)] for y in range(param.num_indicator)]
    start = timeit.default_timer()
    for r in range(param.num_indicator):
        for c in range(param.num_hpc):
            count = 0
            for b in range(param.total_benign):
                    if BinTest[b][t-1][r][c] == 1:
                        count = count + 1
            binning[r][c] = count
    end = timeit.default_timer()
    np.savetxt("Testing_Results/count_"+str(fileCount)+".txt", binning, delimiter = " ", fmt="%0.0f")
    prediction_time = prediction_time + (end - start)
    for r in range(param.num_indicator):
        for c in range(param.num_hpc):
            binning[r][c] = binning[r][c] / (param.total_benign - param.num_test_benign)
    np.savetxt("Testing_Results/normalized_count_"+str(fileCount)+".txt", binning, delimiter = " ", fmt="%0.6f")
    weight = pd.read_csv("normalized_weights.txt", header = None, sep=" ").as_matrix()
#    start = timeit.default_timer()
    result = np.matrix(np.multiply(binning, weight))
    np.savetxt("Testing_Results/score_"+str(fileCount)+".txt", result, delimiter = " ", fmt="%0.6f")
    fileCount = fileCount + 1
    score = result.sum()
#    end = timeit.default_timer()
#    prediction_time = prediction_time + (end - start)
    
    print(score)
    return 0 if score < param.threshold else 1 

def store_bins(benign, malicious):
    if not os.path.exists(param.bin_directory):
        os.makedirs(param.bin_directory)
    for b in range(param.total_benign):
        for m in range(param.total_malware):
            np.savetxt(param.bin_directory+"b"+str(b)+"_m"+str(m)+".txt", Bin[b][m], delimiter = " ", fmt="%0.0f")

def train_t_test_model(benign, malicious):
    train_time = 0
    for b in benign:
        for m in malicious:
            time = calculate_Bin(b, m)
            train_time = train_time + time
    store_bins(benign, malicious)
    time = calculate_weights()
    train_time = train_time + time
    return train_time

def initialize():
    for a in range(param.total_benign):
        for b in range(param.total_malware):
            for i in range(param.num_indicator):
                for j in range(param.num_hpc):
                    BinTest[a][b][i][j] = 0

def test_t_test_model(benign, target):
    global prediction_time
    prediction_time = 0
    pred = []
    for t in target:
        initialize()
        for b in benign:
            calculate_Bin_testing(b, t, target.index(t))
        pred.append(analyze(t))
    return pred, (prediction_time/len(target))