# -*- coding: utf-8 -*-
"""
Created on Sun Sep 3 2017

@author: N1705165D (Manaar)
"""

import pandas as pd
import timeit
import numpy as np
import math
import createBenignMaliciousExamples as cBME

t_critical = 1.677
threshold = 30
col, row = 6, 5;
Matrix = [[0 for x in range(col)] for y in range(row)]
Bin = [[[[0 for x in range(col)] for y in range(row)] for f1 in range(cBME.malware_examples)] for f2 in range(cBME.benign_examples)]
Weights = [[0 for x in range(col)] for y in range(row)]
BinTest = [[[[0 for x in range(col)] for y in range(row)] for f1 in range(cBME.malware_examples)] for f2 in range(cBME.benign_examples)]

prediction_time = 0

def calculate_weights():
    total_count = 0
    start = timeit.default_timer()
    for r in range(row):
        for c in range(col):
            count = 0
            for b in range(cBME.benign_examples):
                for m in range(cBME.malware_examples):
                    if Bin[b][m][r][c] == 1:
                        count = count + 1
            Weights[r][c] = count
            total_count = total_count + count
    for r in range(row):
        for c in range(col):
            Weights[r][c] = Weights[r][c] / total_count
    end = timeit.default_timer()
    np.savetxt("weights.txt", Weights, delimiter = " ", fmt="%0.10f")
    return (end - start)

def create_T_values():
    total_time = 0
    for file1 in range(1, cBME.benign_examples + 1):
        for file2 in range(1, cBME.malware_examples + 1):
            data1 = pd.read_csv("benign/prog"+str(file1)+".txt", header=None, sep=" ").as_matrix()
            data2 = pd.read_csv("malicious/prog"+str(file2)+".txt", header=None, sep=" ").as_matrix()
            total_time = 0
            for c in range(col):
                for r in range(row):
                    dis1 = data1[:, c+r]
                    dis2 = data2[:, c+r]
                    start = timeit.default_timer()
                    t = (np.mean(dis1) - np.mean(dis2)) / (math.sqrt((np.var(dis1)+np.var(dis2))/len(dis1)))
                    end = timeit.default_timer()
                    total_time = total_time + (end - start)
                    Matrix[r][c] = t
            np.savetxt("t_test_results/b"+str(file1)+"_m"+str(file2)+".txt", Matrix, delimiter = " ")
    return total_time

def calculate_Bin(file1, file2):
    data = pd.read_csv("t_test_results/b"+str(file1)+"_m"+str(file2)+".txt", header=None, sep=" ").as_matrix()
    total_time = 0
    for r in range(row):
        for c in range(col):
            start = timeit.default_timer()
            if abs(data[r][c]) >= t_critical:
                Bin[file1 - 1][file2 - 1][r][c] = 1
            end = timeit.default_timer()
            total_time = total_time + (end - start)
    return total_time

def calculate_Bin_testing(file1, file2, index):
    global prediction_time
    data1 = pd.read_csv("benign/prog"+str(file1)+".txt", header=None, sep=" ").as_matrix()
    if index < 10:
        data2 = pd.read_csv("benign/prog"+str(file2)+".txt", header=None, sep=" ").as_matrix()
    else:
        data2 = pd.read_csv("malicious/prog"+str(file2)+".txt", header=None, sep=" ").as_matrix()
    for c in range(col):
        for r in range(row):
            dis1 = data1[:, c+r]
            dis2 = data2[:, c+r]
            start = timeit.default_timer()
            t = (np.mean(dis1) - np.mean(dis2)) / (math.sqrt((np.var(dis1)+np.var(dis2))/len(dis1)))
            if  abs(t) >= t_critical:
                BinTest[file1 - 1][file2 - 1][r][c] = 1
            end = timeit.default_timer()
            prediction_time = prediction_time + (end - start)

#fileCount = 0
def analyze(t):
    global prediction_time
#    global fileCount
    binning = [[0 for x in range(col)] for y in range(row)]
    start = timeit.default_timer()
    for r in range(row):
        for c in range(col):
            count = 0
            for b in range(cBME.benign_examples):
                    if BinTest[b][t-1][r][c] == 1:
                        count = count + 1
            binning[r][c] = count
    end = timeit.default_timer()
    prediction_time = prediction_time + (end - start)
    binning = np.asarray(binning, dtype=np.float64)
    weight = pd.read_csv("weights.txt", header = None, sep=" ").as_matrix()
#    start = timeit.default_timer()
    result = np.matrix(np.multiply(binning, weight))
#    np.savetxt("file"+str(fileCount)+".txt", result, delimiter = " ", fmt="%0.6f")
#    fileCount = fileCount + 1
#    end = timeit.default_timer()
#    prediction_time = prediction_time + (end - start)
    score = result.sum()
    print(score)
    return 0 if score < threshold else 1
    
def train_t_test_model(benign, malicious):
    train_time = 0
    for b in benign:
        for m in malicious:
            time = calculate_Bin(b, m)
            train_time = train_time + time
    time = calculate_weights()
    train_time = train_time + time
    return train_time

def initialize():
    for a in range(cBME.benign_examples):
        for b in range(cBME.malware_examples):
            for i in range(row):
                for j in range(col):
                    BinTest[a][b][i][j] = 0

def test_t_test_model(benign, target):
    global prediction_time
    prediction_time = 0
    pred = []
    for t in target:
        initialize()
        for b in benign:
            calculate_Bin_testing(b, t, target.index(t))
        pred.append(analyze(t))
    return pred, (prediction_time/len(target))