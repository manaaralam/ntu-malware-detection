# -*- coding: utf-8 -*-
"""
Created on Wed Sep  6 15:56:40 2017

@author: N1705165D
"""

import pandas as pd
import numpy as np
import parameters as param
import os
import random

def create_benign_and_malware_files():
    if not os.path.exists(param.data_file):
        print("Data File Not Found..!!")
        return
    
    if not (os.path.exists(param.benign_directory) and os.path.exists(param.malware_directory)):
        os.makedirs(param.benign_directory)
        os.makedirs(param.malware_directory)
    
    raw_data = pd.read_csv(param.data_file, dtype='float64', header=None).as_matrix()[:, :-1]
    for i in range(param.total_benign):
        np.savetxt(param.benign_directory+"prog"+str(i+1)+".txt", raw_data[(i*50):((i+1)*50), :], fmt="%.1f")
    for i in range(param.total_malware):
        np.savetxt(param.malware_directory+"prog"+str(i+1)+".txt", raw_data[((54*50)+(i*50)):((54*50)+(i+1)*50), :], fmt="%.1f")
    print("All the Benign and Malware files created..")

def generate_benign_data():
    if not os.path.exists(param.temporary_directory):
        os.makedirs(param.temporary_directory)
    train_benign = random.sample(range(1, param.total_benign + 1), param.total_benign - param.num_test_benign)
    test_benign = []
    for item in range(1, param.total_benign + 1):
        if item not in train_benign:
            test_benign.append(item)
    train_benign.sort()
    test_benign.sort()
    with open(param.temporary_directory+"train_benign_program_list.txt", "w") as outFile:
        for item in train_benign:
            outFile.write("%s " % item)
    with open(param.temporary_directory+"test_benign_program_list.txt", "w") as outFile:
        for item in test_benign:
            outFile.write("%s " % item)
    print("Benign Train and Test files are selected..")
    return train_benign, test_benign

def generate_malware_data():
    train_malware = random.sample(range(1, param.total_malware + 1), param.total_malware - param.num_test_malware)
    test_malware = []
    for item in range(1, param.total_malware + 1):
        if item not in train_malware:
            test_malware.append(item)
    train_malware.sort()
    test_malware.sort()
    with open(param.temporary_directory+"train_malware_program_list.txt", "w") as outFile:
        for item in train_malware:
            outFile.write("%s " % item)
    with open(param.temporary_directory+"test_malware_program_list.txt", "w") as outFile:
        for item in test_malware:
            outFile.write("%s " % item)
    print("Malware Train and Test files are selected..")
    return train_malware, test_malware

def get_dev_matrix(data):
    constant = np.matrix(np.full((data.shape[0], data.shape[0]), 1))
    dev = data - np.divide(np.matmul(constant, data), data.shape[0])
    return dev

def get_cov_matrix(data):
    dev_matrix = get_dev_matrix(data)
    cov = np.divide(np.matmul(dev_matrix.transpose(), dev_matrix), data.shape[0] - 1)
    return cov

def hotelling(data1, data2):
    n1 = param.iteration
    n2 = param.iteration
    n = n1 + n2 - 1
    matrix1 = np.matrix(data1)
    matrix2 = np.matrix(data2)
    mu1 = matrix1.sum(0) / n1
    mu2 = matrix2.sum(0) / n2
    diff = mu1 - mu2
    diff_t = diff.transpose()
    sigma1 = get_cov_matrix(matrix1)
    sigma2 = get_cov_matrix(matrix2)
    pooled_sigma = np.divide((np.multiply(sigma1, n1 - 1) + np.multiply(sigma2, n2 - 1)), n-1)
    T = np.array(np.matmul(np.matmul(diff, np.linalg.inv(pooled_sigma)), diff_t))[0][0]
    T = T * ((n1 * n2)/(n1 + n2))
    return T

test_list = []
def create_F_values():
    n1 = param.iteration
    n2 = param.iteration
    n = n1 + n2 - 1
    k = param.variable
    if not os.path.exists(param.t_values_directory):
        os.makedirs(param.t_values_directory)
    for file1 in range(1, param.total_benign + 1):
        for file2 in range(1, param.total_malware + 1):
            data1 = pd.read_csv(param.benign_directory+"prog"+str(file1)+".txt", header=None, sep=" ").as_matrix()
            data2 = pd.read_csv(param.malware_directory+"prog"+str(file2)+".txt", header=None, sep=" ").as_matrix()
            hotelling_value = hotelling(data1, data2)
            F_value = ((n - k) / (k * (n - 1))) * hotelling_value
            if F_value > param.F_critical:
                test_list.append(1)
            else:
                test_list.append(0)
 
def main():
    create_benign_and_malware_files()
    train_benign, test_benign = generate_benign_data()
    train_malware, test_malware = generate_malware_data()
    create_F_values()

if __name__ == "__main__":
    main()