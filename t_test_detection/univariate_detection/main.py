# -*- coding: utf-8 -*-
"""
Created on Wed Sep  6 15:56:40 2017

@author: N1705165D
"""

import pandas as pd
import numpy as np
import parameters as param
import os
import random
import math
from scipy import stats

Matrix = [[0 for x in range(param.num_hpc)] for y in range(param.num_indicator)]
Bin = [[[[0 for x in range(param.num_hpc)] for y in range(param.num_indicator)] for f1 in range(param.total_malware)] for f2 in range(param.total_benign)]
Weights = [[0 for x in range(param.num_hpc)] for y in range(param.num_indicator)]
BinTest = [[[[0 for x in range(param.num_hpc)] for y in range(param.num_indicator)] for f1 in range(param.total_malware)] for f2 in range(param.total_benign)]

def create_benign_and_malware_files():
    if not os.path.exists(param.data_file):
        print("Data File Not Found..!!")
        return
    if not (os.path.exists(param.benign_directory) and os.path.exists(param.malware_directory)):
        os.makedirs(param.benign_directory)
        os.makedirs(param.malware_directory)
    raw_data = pd.read_csv(param.data_file, dtype='float64', header=None).as_matrix()[:, :-1]
    for i in range(param.total_benign):
        np.savetxt(param.benign_directory+"prog"+str(i+1)+".txt", raw_data[(i*50):((i+1)*50), :], fmt="%.1f")
    for i in range(param.total_malware):
        np.savetxt(param.malware_directory+"prog"+str(i+1)+".txt", raw_data[((54*50)+(i*50)):((54*50)+(i+1)*50), :], fmt="%.1f")
    print("All the Benign and Malware files created..")

def generate_benign_data():
    if not os.path.exists(param.temporary_directory):
        os.makedirs(param.temporary_directory)
    train_benign = random.sample(range(1, param.total_benign + 1), param.total_benign - param.num_test_benign)
    test_benign = []
    for item in range(1, param.total_benign + 1):
        if item not in train_benign:
            test_benign.append(item)
    train_benign.sort()
    test_benign.sort()
    with open(param.temporary_directory+"train_benign_program_list.txt", "w") as outFile:
        for item in train_benign:
            outFile.write("%s " % item)
    with open(param.temporary_directory+"test_benign_program_list.txt", "w") as outFile:
        for item in test_benign:
            outFile.write("%s " % item)
    print("Benign Train and Test files are selected..")
    return train_benign, test_benign

def generate_malware_data():
    train_malware = random.sample(range(1, param.total_malware + 1), param.total_malware - param.num_test_malware)
    test_malware = []
    for item in range(1, param.total_malware + 1):
        if item not in train_malware:
            test_malware.append(item)
    train_malware.sort()
    test_malware.sort()
    with open(param.temporary_directory+"train_malware_program_list.txt", "w") as outFile:
        for item in train_malware:
            outFile.write("%s " % item)
    with open(param.temporary_directory+"test_malware_program_list.txt", "w") as outFile:
        for item in test_malware:
            outFile.write("%s " % item)
    print("Malware Train and Test files are selected..")
    return train_malware, test_malware

def create_t_values():
    print("Creating t-values for all the (benign, malware) tuple..")
    if not os.path.exists(param.t_values_directory):
        os.makedirs(param.t_values_directory)
    for file1 in range(1, param.total_benign + 1):
        for file2 in range(1, param.total_malware + 1):
            data1 = pd.read_csv(param.benign_directory+"prog"+str(file1)+".txt", header=None, sep=" ").as_matrix()
            data2 = pd.read_csv(param.malware_directory+"prog"+str(file2)+".txt", header=None, sep=" ").as_matrix()
            for c in range(param.num_hpc):
                for r in range(param.num_indicator):
#                    dis1 = data1[:, param.num_indicator * c + r]
#                    dis2 = data2[:, param.num_indicator * c + r]
                    dis1 = data1[:, c + r]
                    dis2 = data2[:, c + r]
                    t = (np.mean(dis1) - np.mean(dis2)) / (math.sqrt((np.var(dis1) + np.var(dis2))/len(dis1)))
                    Matrix[r][c] = t
            np.savetxt(param.t_values_directory+"b"+str(file1)+"_m"+str(file2)+".txt", Matrix, delimiter = " ", fmt="%0.6f")
    print("All t-values created..")

def calculate_Bin(file1, file2):
    data = pd.read_csv(param.t_values_directory+"b"+str(file1)+"_m"+str(file2)+".txt", header=None, sep=" ").as_matrix()
    for r in range(param.num_indicator):
        for c in range(param.num_hpc):
            if abs(data[r][c]) >= param.t_critical:
                Bin[file1 - 1][file2 - 1][r][c] = 1

def store_bins():
    if not os.path.exists(param.bin_directory):
        os.makedirs(param.bin_directory)
    for b in range(param.total_benign):
        for m in range(param.total_malware):
            np.savetxt(param.bin_directory+"b"+str(b)+"_m"+str(m)+".txt", Bin[b][m], delimiter = " ", fmt="%0.0f")
            
def calculate_weights():
    print("Creating weights for train set data..")
    total_count = 0
    for r in range(param.num_indicator):
        for c in range(param.num_hpc):
            count = 0
            for b in range(param.total_benign):
                for m in range(param.total_malware):
                    if Bin[b][m][r][c] == 1:
                        count = count + 1
            Weights[r][c] = count
            total_count = total_count + count
    np.savetxt("weights.txt", Weights, delimiter = " ", fmt="%0.0f")
    for r in range(param.num_indicator):
        for c in range(param.num_hpc):
            Weights[r][c] = Weights[r][c] / total_count    
    np.savetxt("normalized_weights.txt", Weights, delimiter = " ", fmt="%0.6f")
    print("Weights are created..")

def train_t_test_model(benign, malware):
    print("Training Started..")
    print("Creating Bin Files for train set data..")
    for b in benign:
        for m in malware:
            calculate_Bin(b, m)
    store_bins()
    print("Bin Files Created..")
    calculate_weights()
    print("Training Complete..")

def calculate_Bin_testing(file1, file2, index):
    data1 = pd.read_csv(param.benign_directory+"prog"+str(file1)+".txt", header=None, sep=" ").as_matrix()
    if index < 10:
        data2 = pd.read_csv(param.benign_directory+"prog"+str(file2)+".txt", header=None, sep=" ").as_matrix()
    else:
        data2 = pd.read_csv(param.malware_directory+"prog"+str(file2)+".txt", header=None, sep=" ").as_matrix()
    for c in range(param.num_hpc):
        for r in range(param.num_indicator):
#            dis1 = data1[:, param.num_indicator * c + r]
#            dis2 = data2[:, param.num_indicator * c + r]
            dis1 = data1[:, c + r]
            dis2 = data2[:, c + r]
            t = (np.mean(dis1) - np.mean(dis2)) / (math.sqrt((np.var(dis1)+np.var(dis2))/len(dis1)))
            if abs(t) >= param.t_critical:
                BinTest[file1 - 1][file2 - 1][r][c] = 1

def analyze(t, fileCount):
    if not os.path.exists(param.test_directory):
        os.makedirs(param.test_directory)
    binning = [[0 for x in range(param.num_hpc)] for y in range(param.num_indicator)]
    for r in range(param.num_indicator):
        for c in range(param.num_hpc):
            count = 0
            for b in range(param.total_benign):
                    if BinTest[b][t-1][r][c] == 1:
                        count = count + 1
            binning[r][c] = count
    np.savetxt("Testing_Results/count_"+str(fileCount)+".txt", binning, delimiter = " ", fmt="%0.0f")
    for r in range(param.num_indicator):
        for c in range(param.num_hpc):
            binning[r][c] = binning[r][c] / (param.total_benign - param.num_test_benign)
    np.savetxt("Testing_Results/normalized_count_"+str(fileCount)+".txt", binning, delimiter = " ", fmt="%0.6f")
    weight = pd.read_csv("normalized_weights.txt", header = None, sep=" ").as_matrix()
    result = np.matrix(np.multiply(binning, weight))
    np.savetxt("Testing_Results/score_"+str(fileCount)+".txt", result, delimiter = " ", fmt="%0.6f")
    score = result.sum()
    return 0 if score < param.threshold else 1, score

def initialize():
    for a in range(param.total_benign):
        for b in range(param.total_malware):
            for i in range(param.num_indicator):
                for j in range(param.num_hpc):
                    BinTest[a][b][i][j] = 0
                    
def test_t_test_model(benign, target):
    test_file_index = 0
    print("Testing Started..")
    pred = []
    for t in target:
        print("Testing File %d" % (test_file_index + 1))
        initialize()
        for b in benign:
            calculate_Bin_testing(b, t, test_file_index)
        pred.append(analyze(t, test_file_index))
        test_file_index = test_file_index + 1
    print("Testing Complete..")
    return pred

data_set = 1
def read_train_test_file():
    train_benign = pd.read_csv("Backup/Set "+str(data_set)+"/train_benign_program_list.txt", header=None, sep=" ").as_matrix()[:, :-1].astype(int).tolist()
    train_malware = pd.read_csv("Backup/Set "+str(data_set)+"/train_malware_program_list.txt", header=None, sep=" ").as_matrix()[:, :-1].astype(int).tolist()
    test_benign = pd.read_csv("Backup/Set "+str(data_set)+"/test_benign_program_list.txt", header=None, sep=" ").as_matrix()[:, :-1].astype(int).tolist()
    test_malware = pd.read_csv("Backup/Set "+str(data_set)+"/test_malware_program_list.txt", header=None, sep=" ").as_matrix()[:, :-1].astype(int).tolist()
    return train_benign[0], train_malware[0], test_benign[0], test_malware[0]

def main():
#    create_benign_and_malware_files()
#    create_t_values()
    train_benign, train_malware, test_benign, test_malware = read_train_test_file()
#    train_benign, test_benign = generate_benign_data()
#    train_malware, test_malware = generate_malware_data()
    train_t_test_model(train_benign, train_malware)
    pred = test_t_test_model(train_benign, test_benign + test_malware)
#    pred = test_t_test_model(train_benign, [55])
#    print("Results of Testing..")
    with open(str(param.alpha)+"_score.txt", "w") as out:
        for item in pred:
            print("%d -> %0.6f (%s)" % (item[0], item[1], "Benign" if item[0] == 0 else "Malware"))
            out.write("%s\n" % item[1])

if __name__ == "__main__":
    main()