# -*- coding: utf-8 -*-
"""
Created on Wed Sep  6 15:56:40 2017

@author: N1705165D
"""

import pandas as pd
import numpy as np
import parameters as param
import os
import random

Bin = [[[0 for x in range(param.num_indicator)] for f1 in range(param.total_malware)] for f2 in range(param.total_benign)]
BinTest = [[[0 for x in range(param.num_indicator)] for f1 in range(param.total_malware)] for f2 in range(param.total_benign)]
Weights = [0 for x in range(param.num_indicator)]

def generate_benign_data():
    if not os.path.exists(param.temporary_directory):
        os.makedirs(param.temporary_directory)
    train_benign = random.sample(range(1, param.total_benign + 1), param.total_benign - param.num_test_benign)
    test_benign = []
    for item in range(1, param.total_benign + 1):
        if item not in train_benign:
            test_benign.append(item)
    train_benign.sort()
    test_benign.sort()
    with open(param.temporary_directory+"train_benign_program_list.txt", "w") as outFile:
        for item in train_benign:
            outFile.write("%s " % item)
    with open(param.temporary_directory+"test_benign_program_list.txt", "w") as outFile:
        for item in test_benign:
            outFile.write("%s " % item)
    return train_benign, test_benign

def generate_malware_data():
    train_malware = random.sample(range(1, param.total_malware + 1), param.total_malware - param.num_test_malware)
    test_malware = []
    for item in range(1, param.total_malware + 1):
        if item not in train_malware:
            test_malware.append(item)
    train_malware.sort()
    test_malware.sort()
    with open(param.temporary_directory+"train_malware_program_list.txt", "w") as outFile:
        for item in train_malware:
            outFile.write("%s " % item)
    with open(param.temporary_directory+"test_malware_program_list.txt", "w") as outFile:
        for item in test_malware:
            outFile.write("%s " % item)
    return train_malware, test_malware

def get_dev_matrix(data):
    constant = np.matrix(np.full((data.shape[0], data.shape[0]), 1))
    dev = data - np.divide(np.matmul(constant, data), data.shape[0])
    return dev

def get_cov_matrix(data):
    dev_matrix = get_dev_matrix(data)
    cov = np.divide(np.matmul(dev_matrix.transpose(), dev_matrix), data.shape[0] - 1)
    return cov

def get_pooled_sigma(s1, n1, s2, n2):
    S = np.multiply(s1, n1 - 1) + np.multiply(s2, n2 - 1)
    S = np.divide(S, n1 + n2 - 2)
    return S
    
def hotelling(data1, data2):
    n1 = len(data1)
    n2 = len(data2)
    matrix1 = np.matrix(data1)
    matrix2 = np.matrix(data2)
    mu1 = matrix1.sum(0) / n1
    mu2 = matrix2.sum(0) / n2
    diff = mu1 - mu2
    diff_t = diff.transpose()
    sigma1 = get_cov_matrix(matrix1)
    sigma2 = get_cov_matrix(matrix2)
    combined_sigma = get_pooled_sigma(sigma1, n1, sigma2, n2)
    T = np.array(np.matmul(np.matmul(diff, np.linalg.inv(combined_sigma)), diff_t))[0][0]
    T = ((n1 * n2) / (n1 + n2)) * T 
    return T

def create_F_values():
    n1 = param.iteration
    n2 = param.iteration
    n = n1 + n2 - 1
    k = param.variable
    if not os.path.exists(param.f_values_directory):
        os.makedirs(param.f_values_directory)
    for file1 in range(1, param.total_benign + 1):
        for file2 in range(1, param.total_malware + 1):
            F_vector = []
            data1 = pd.read_csv(param.benign_directory+"prog ("+str(file1)+").txt", header=None, sep=" ").as_matrix()
            data2 = pd.read_csv(param.malware_directory+"prog ("+str(file2)+").txt", header=None, sep=" ").as_matrix()
            for i in range(param.num_indicator):
                dis1 = data1[:, [i, i + param.num_indicator, i + 2 * param.num_indicator, i + 3 * param.num_indicator, i + 4 * param.num_indicator, i + 5 * param.num_indicator]]
                dis2 = data2[:, [i, i + param.num_indicator, i + 2 * param.num_indicator, i + 3 * param.num_indicator, i + 4 * param.num_indicator, i + 5 * param.num_indicator]]
                hotelling_value = hotelling(dis1, dis2)
                F_value = ((n - k) / (k * (n - 1))) * hotelling_value
                F_vector.append(F_value)
            np.savetxt(param.f_values_directory+"b"+str(file1)+"_m"+str(file2)+".txt", np.array(F_vector), fmt="%0.6f")

def calculate_Bin(file1, file2):
    data = pd.read_csv(param.f_values_directory+"b"+str(file1)+"_m"+str(file2)+".txt", header=None, sep=" ").as_matrix()
    for i in range(param.num_indicator):
        if abs(data[i][0]) >= param.F_critical:
            Bin[file1 - 1][file2 - 1][i] = 1

def store_bins():
    if not os.path.exists(param.bin_directory):
        os.makedirs(param.bin_directory)
    for b in range(param.total_benign):
        for m in range(param.total_malware):
            np.savetxt(param.bin_directory+"b"+str(b)+"_m"+str(m)+".txt", Bin[b][m], delimiter = " ", fmt="%0.0f")

def calculate_weights():
    for i in range(param.num_indicator):
        count = 0
        for b in range(param.total_benign):
            for m in range(param.total_malware):
                if Bin[b][m][i] == 1:
                    count = count + 1
        Weights[i] = count
    np.savetxt("weights.txt", Weights, delimiter = " ", fmt="%0.0f")
    total = sum(Weights)
    for i in range(param.num_indicator):
        Weights[i] = Weights[i] / total
    np.savetxt("normalized_weights.txt", Weights, delimiter = " ", fmt="%0.6f")

def train_hotelling_model(benign, malware):
    for b in benign:
        for m in malware:
            calculate_Bin(b, m)
    store_bins()
    calculate_weights()

def calculate_Bin_testing(file1, file2, index):
    n1 = param.iteration
    n2 = param.iteration
    n = n1 + n2 - 1
    k = param.variable
    data1 = pd.read_csv(param.benign_directory+"prog ("+str(file1)+").txt", header=None, sep=" ").as_matrix()
    if index < 10:
        data2 = pd.read_csv(param.benign_directory+"prog ("+str(file2)+").txt", header=None, sep=" ").as_matrix()
    else:
        data2 = pd.read_csv(param.malware_directory+"prog ("+str(file2)+").txt", header=None, sep=" ").as_matrix()
    for i in range(param.num_indicator):
        dis1 = data1[:, [i, i + param.num_indicator, i + 2 * param.num_indicator, i + 3 * param.num_indicator, i + 4 * param.num_indicator, i + 5 * param.num_indicator]]
        dis2 = data2[:, [i, i + param.num_indicator, i + 2 * param.num_indicator, i + 3 * param.num_indicator, i + 4 * param.num_indicator, i + 5 * param.num_indicator]]
        t = hotelling(dis1, dis2)
        F_value = ((n - k) / (k * (n - 1))) * t
        if(abs(F_value)>=param.F_critical):
            BinTest[file1-1][file2-1][i] = 1

fileCount = 0
def analyze(t):
    if not os.path.exists(param.test_directory):
        os.makedirs(param.test_directory)
    global fileCount
    binning = [0 for x in range(param.num_indicator)]
    for i in range(param.num_indicator):
        count = 0
        for b in range(param.total_benign):
            if BinTest[b][t-1][i] == 1:
                count = count + 1
        binning[i] = count
    np.savetxt("Testing_Results/count_"+str(fileCount)+".txt", binning, delimiter = " ", fmt="%0.0f")
    for i in range(param.num_indicator):
        binning[i] = binning[i] / (param.total_benign - param.num_test_benign)
    np.savetxt("Testing_Results/normalized_count_"+str(fileCount)+".txt", binning, delimiter = " ", fmt="%0.6f")
    weight = pd.read_csv("normalized_weights.txt", header = None, sep=" ").as_matrix()
    binning = np.array(binning).reshape(param.num_indicator, 1)
    result = np.matrix(np.multiply(binning, weight))
    np.savetxt("Testing_Results/score_"+str(fileCount)+".txt", result, delimiter = " ", fmt="%0.6f")
    fileCount = fileCount + 1
    score = result.sum()
    return 0 if score < param.threshold else 1, score 

def initialize():
    for a in range(param.total_benign):
        for b in range(param.total_malware):
            for i in range(param.num_indicator):
                BinTest[a][b][i] = 0

def test_hotelling_model(benign, target):
    test_file_index = 0
    pred = []
    for t in target:
        initialize()
        for b in benign:
            calculate_Bin_testing(b, t, test_file_index)
        pred.append(analyze(t))
        test_file_index = test_file_index + 1
    return pred

def main():
#    create_F_values()
    fp = 0
    fn = 0
    for loop in range(1000):
        print(loop)
        train_benign, test_benign = generate_benign_data()
        train_malware, test_malware = generate_malware_data()
        train_hotelling_model(train_benign, train_malware)
        pred = test_hotelling_model(train_benign, test_benign + test_malware)
#        print("Results of Testing..")
#        with open("score.txt", "w") as out:
#            for item in pred:
#                print("%d -> %0.6f (%s)" % (item[0], item[1], "Benign" if item[1] < param.threshold else "Malware"))
#                out.write("%s\n" % item[1])
        for i in range(len(pred)):
            if i < 10 and pred[i][1] > param.threshold:
                fp += 1
            if i > 9 and pred[i][1] < param.threshold:
                fn += 1
    print(fp, fn)
    print("%0.3f, %0.3f" % (float((fp*100)/(1000.0 * 20)), float((fn*100)/(1000.0 * 20))))
if __name__ == "__main__":
    main()